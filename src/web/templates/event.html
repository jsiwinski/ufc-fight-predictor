{% extends "base.html" %}

{% block title %}{{ event.event_name if event else 'Event Not Found' }}{% endblock %}

{% block content %}
{% if error %}
<div class="error-message">
    <h2>Event Not Found</h2>
    <p>{{ error }}</p>
    <p style="margin-top: 20px;"><a href="/">Back to Home</a></p>
</div>
{% elif event %}
<div class="event-header">
    <h1 class="event-name">{{ event.event_name }}</h1>
    <p class="event-meta">{{ event.event_date|format_date_long }}</p>
    <p class="event-summary">
        {{ event.fight_count }} fights &middot;
        Model confidence: <span class="confidence-high">{{ event.confidence_counts.HIGH }} High</span>, <span class="confidence-medium">{{ event.confidence_counts.MEDIUM }} Medium</span>, <span class="confidence-low">{{ event.confidence_counts.LOW }} Low</span>
    </p>
</div>

{% if event.is_backtest %}
<div class="backtest-banner">
    <div>
        {% if event.prediction_type == 'backtest' %}
        <span class="label">Backtest Results</span>
        {% elif event.locked %}
        <span class="label">Locked Results</span>
        {% else %}
        <span class="label">Results</span>
        {% endif %}
    </div>
    <div class="result">
        {{ event.correct }}/{{ event.total }} correct
    </div>
    <div class="accuracy">
        {{ event.accuracy_pct }}% accuracy
    </div>
</div>
{% if event.model_version %}
<div class="model-info-banner">
    <span class="model-label">Model: {{ event.model_version|replace('_ensemble_v1', '')|replace('_v1', '') }}</span>
    {% if event.locked_at %}
    <span class="lock-date">&middot; Locked {{ event.locked_at[:10] }}</span>
    {% endif %}
</div>
{% endif %}
{% endif %}

<div class="fight-list">
    {% set prelim_started = namespace(value=false) %}
    {% for fight in event.predictions %}
    {# Insert prelim divider before first prelim fight #}
    {% if fight.card_section == 'prelim' and not prelim_started.value %}
    {% set prelim_started.value = true %}
    <div class="card-section-divider">
        <span class="card-section-label">Preliminary Card</span>
    </div>
    {% endif %}
    <div class="fight-card {% if fight.position_label == 'Main Event' %}main-event{% endif %} {% if fight.card_section == 'prelim' %}prelim{% endif %} favorite-{{ fight.favorite }}">
        {% if fight.position_label %}
        <div class="fight-position">{{ fight.position_label }}</div>
        {% endif %}

        <div class="fight-row">
            {# Fighter 1 (Left Side) #}
            <div class="fighter-side left">
                {# Headshot #}
                {% if fight.f1_headshot %}
                <img src="{{ fight.f1_headshot }}" alt="{{ fight.fighter1 }}" class="fighter-headshot" loading="lazy">
                {% else %}
                <div class="fighter-headshot-fallback">{{ fight.f1_initials }}</div>
                {% endif %}

                <div class="fighter-info">
                    <div class="fighter-name">{{ fight.fighter1 }}</div>
                    <div class="fighter-meta">{{ fight.weight_class }}</div>
                    <div class="fighter-elo {% if fight.f1_elo > fight.f2_elo %}higher{% endif %}">Elo: {{ fight.f1_elo }}</div>
                    {% if not fight.f1_exact_match %}
                    <div class="match-warning">Matched to: {{ fight.fighter1_matched }}</div>
                    {% endif %}
                </div>
                <div class="prob-display">
                    <span class="probability red">{{ fight.f1_pct }}%</span>
                    <div class="prob-bar-container">
                        <div class="prob-bar" style="width: {{ (fight.f1_prob * 100)|int }}%;"></div>
                    </div>
                </div>
            </div>

            {# Center Divider #}
            <div class="vs-divider">vs</div>

            {# Fighter 2 (Right Side) #}
            <div class="fighter-side right">
                <div class="prob-display">
                    <div class="prob-bar-container">
                        <div class="prob-bar" style="width: {{ (fight.f2_prob * 100)|int }}%;"></div>
                    </div>
                    <span class="probability blue">{{ fight.f2_pct }}%</span>
                </div>
                <div class="fighter-info">
                    <div class="fighter-name">{{ fight.fighter2 }}</div>
                    <div class="fighter-meta">{{ fight.weight_class }}</div>
                    <div class="fighter-elo {% if fight.f2_elo > fight.f1_elo %}higher{% endif %}">Elo: {{ fight.f2_elo }}</div>
                    {% if not fight.f2_exact_match %}
                    <div class="match-warning">Matched to: {{ fight.fighter2_matched }}</div>
                    {% endif %}
                </div>

                {# Headshot #}
                {% if fight.f2_headshot %}
                <img src="{{ fight.f2_headshot }}" alt="{{ fight.fighter2 }}" class="fighter-headshot" loading="lazy">
                {% else %}
                <div class="fighter-headshot-fallback">{{ fight.f2_initials }}</div>
                {% endif %}
            </div>
        </div>

        {# Confidence Badge #}
        <div style="text-align: center;">
            <span class="confidence-badge {% if fight.confidence == 'HIGH' %}high{% elif fight.confidence == 'MEDIUM' %}medium{% endif %}">{{ fight.confidence }}</span>
        </div>

        {# Tornado Chart (visible on hover) with Body Photos #}
        {% if fight.tornado_factors %}
        <div class="fight-details">
            <div class="fight-details-content {% if fight.f1_body_photo and fight.f2_body_photo %}has-both-photos{% elif fight.f1_body_photo %}has-left-photo{% elif fight.f2_body_photo %}has-right-photo{% else %}no-photos{% endif %}">
                {# Fighter 1 Body Photo #}
                {% if fight.f1_body_photo %}
                <img src="{{ fight.f1_body_photo }}" alt="{{ fight.fighter1 }}" class="fighter-body-photo left {% if fight.f1_flip %}flipped{% endif %}" loading="lazy">
                {% endif %}

                <div class="tornado-section">
                    {% for factor in fight.tornado_factors %}
                    <div class="tornado-row">
                        <div class="tornado-bar-left">
                            <div class="tornado-fill red" style="width: {{ factor.left_width }}%;"></div>
                        </div>
                        <div class="tornado-label">{{ factor.label }}</div>
                        <div class="tornado-bar-right">
                            <div class="tornado-fill blue" style="width: {{ factor.right_width }}%;"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {# Fighter 2 Body Photo #}
                {% if fight.f2_body_photo %}
                <img src="{{ fight.f2_body_photo }}" alt="{{ fight.fighter2 }}" class="fighter-body-photo right {% if fight.f2_flip %}flipped{% endif %}" loading="lazy">
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Backtest Result #}
        {% if event.is_backtest and fight.actual_winner %}
        <div class="result-indicator {% if fight.correct %}correct{% else %}wrong{% endif %}">
            {% if fight.correct %}
            Correct — {{ fight.actual_winner }} won via {{ fight.method }}
            {% else %}
            Wrong — {{ fight.actual_winner }} won via {{ fight.method }}
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}
